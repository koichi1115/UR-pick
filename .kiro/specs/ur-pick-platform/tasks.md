# Implementation Plan

## 概要

UR-pickプラットフォームのMVP（最小実行可能製品）を実装するためのタスク一覧です。各タスクは1〜3時間程度で完了できる粒度に分割されています。要件定義書と技術設計書に基づき、段階的に機能を実装していきます。

---

## MVP実装タスク

- [x] 1. プロジェクト基盤のセットアップ
- [x] 1.1 フロントエンドプロジェクトの初期化
  - React 18+ with TypeScriptプロジェクトをViteで作成
  - 必要な依存関係をインストール（React Router、React Spring、React Use Gesture等）
  - ESLintとPrettierの設定
  - ディレクトリ構造を設計書に従って構築
  - _Requirements: 全要件の基盤となるプロジェクト構造_

- [x] 1.2 バックエンドプロジェクトの初期化
  - Node.js (Express) with TypeScriptプロジェクトを作成
  - 必要な依存関係をインストール（Express、PostgreSQLクライアント、Claude SDK等）
  - ESLintとPrettierの設定
  - 環境変数管理の仕組みを構築（dotenv）
  - _Requirements: 全要件の基盤となるバックエンド構造_

- [x] 1.3 開発環境とツールの設定
  - TypeScript設定ファイル（tsconfig.json）を最適化
  - ビルドスクリプトとdev serverの設定
  - Git ignoreファイルの設定
  - _Requirements: 開発効率を向上させる基盤_

---

- [x] 2. データベースとデータモデルの構築
- [x] 2.1 PostgreSQLデータベースのセットアップ
  - Supabaseプロジェクトを作成、またはローカルPostgreSQLをセットアップ
  - データベース接続設定をバックエンドに追加
  - 接続テストを実装
  - _Requirements: 7.1, 7.2, 7.3（ユーザープロファイルとデータ保存の基盤）_

- [x] 2.2 データベーススキーマの作成
  - usersテーブルを作成（user_id, created_at, updated_at, last_login_at）
  - swipe_historyテーブルを作成（swipe_id, user_id, product_id, direction, swiped_at等）
  - purchase_historyテーブルを作成（purchase_id, user_id, product_id, affiliate_url等）
  - user_preferencesテーブルを作成（user_id, preferences JSONB, updated_at）
  - 必要なインデックスを作成（設計書に記載の通り）
  - _Requirements: 7.2, 7.3（スワイプ履歴と購買履歴の保存）_

- [x] 2.3 データモデルとTypeScript型定義の作成
  - User、SwipeRecord、PurchaseRecord、UserProfile等のTypeScript型を定義
  - データベースとアプリケーション層の型を統一
  - _Requirements: 型安全性の確保_

---

- [x] 3. バックエンドAPI基盤の構築
- [x] 3.1 Expressサーバーの基本構成
  - Expressアプリケーションの初期化
  - ミドルウェアの設定（CORS、JSON parser、エラーハンドラー等）
  - ルーティングの基本構造を構築
  - ヘルスチェックエンドポイント（/api/health）を実装
  - _Requirements: 全APIエンドポイントの基盤_

- [x] 3.2 エラーハンドリングとロギングの実装
  - 統一されたエラーレスポンス形式を定義
  - カスタムエラークラスの実装（UserError、SystemError、BusinessLogicError）
  - 構造化ロギングの実装（JSON形式）
  - _Requirements: Error Handling戦略に準拠_

- [x] 3.3 データベースアクセス層の構築
  - PostgreSQLクライアントの初期化とコネクションプール設定
  - 基本的なCRUD操作のヘルパー関数を実装
  - トランザクション管理の仕組みを構築
  - _Requirements: データベース操作の基盤_

---

- [x] 4. アフィリエイトAPI統合
- [x] 4.1 Amazon Product Advertising APIクライアントの実装
  - Amazon PA-APIのSDKをインストール
  - API認証の設定（Access Key、Secret Key）
  - 商品検索機能の実装（SearchItemsエンドポイント）
  - レスポンスデータを共通のProduct型に変換
  - エラーハンドリングとリトライロジックの実装
  - _Requirements: 2.1（複数のアフィリエイトAPIからデータ取得）_

- [x] 4.2 楽天市場APIクライアントの実装
  - 楽天市場APIのHTTPクライアントを実装
  - API認証の設定（アプリケーションID）
  - 商品検索機能の実装（ItemSearchエンドポイント）
  - レスポンスデータを共通のProduct型に変換
  - エラーハンドリングとリトライロジックの実装
  - _Requirements: 2.1（複数のアフィリエイトAPIからデータ取得）_

- [x] 4.3 Yahoo!ショッピングAPIクライアントの実装
  - Yahoo!ショッピングAPIのHTTPクライアントを実装
  - API認証の設定（Client ID）
  - 商品検索機能の実装（itemSearchエンドポイント）
  - レスポンスデータを共通のProduct型に変換
  - エラーハンドリングとリトライロジックの実装
  - _Requirements: 2.1（複数のアフィリエイトAPIからデータ取得）_

- [x] 4.4 アフィリエイトAPIの並列呼び出しと統合
  - 複数のAPIクライアントを並列で呼び出す機能を実装
  - 商品データの統合と重複除去ロジックを実装
  - タイムアウト処理とCircuit Breakerパターンを実装
  - レスポンスキャッシュの仕組みを構築（Redis or メモリキャッシュ）
  - _Requirements: 2.1, 2.7（10秒以内のレスポンス）_

---

- [ ] 5. AIレコメンデーションエンジンの実装
- [ ] 5.1 Claude API統合の基盤構築
  - Claude SDKのインストールと設定
  - API認証の設定（APIキー）
  - 基本的なメッセージ送信機能を実装
  - エラーハンドリングとレート制限対応を実装
  - _Requirements: 2.2, 2.6（AIレコメンドとおすすめ理由生成）_

- [ ] 5.2 商品スコアリングロジックの実装
  - ベーススコア計算ロジックを実装（価格、レビュー評価、レビュー数）
  - クエリマッチスコア計算ロジックを実装（キーワードマッチング）
  - パーソナライズスコア計算ロジックを実装（ユーザープロファイルとの一致度）
  - 総合スコア計算と上位5〜10件の選定ロジックを実装
  - _Requirements: 2.2, 2.3（商品選定とスコアリング）_

- [ ] 5.3 初回ユーザー向けルールベースレコメンドの実装
  - リクエストキーワードマッチングロジックを実装
  - 人気商品スコアの計算ロジックを実装
  - 初回ユーザー判定ロジックを実装
  - _Requirements: 2.4（初回ユーザー向けレコメンド）_

- [ ] 5.4 リピートユーザー向けLLMベースレコメンドの実装
  - ユーザープロファイルをプロンプトに含める機能を実装
  - Claude APIを使用したパーソナライズドレコメンドを実装
  - プロンプトテンプレートの設計と最適化
  - _Requirements: 2.5（過去の履歴を重視したパーソナライズ）_

- [ ] 5.5 推薦理由の生成機能の実装
  - Claude APIを使用した「おすすめ理由」の生成機能を実装
  - 各商品に対して簡潔な推薦理由を生成
  - プロンプトテンプレートの最適化（コスト削減）
  - _Requirements: 2.6（おすすめ理由の生成）_

- [ ] 5.6 レコメンデーションAPIエンドポイントの実装
  - POST /api/recommendationsエンドポイントを実装
  - リクエストバリデーション（queryが空でないことを確認）
  - AIレコメンデーションエンジンの呼び出し
  - レスポンスの整形とエラーハンドリング
  - _Requirements: 1.2, 2.1, 2.7（リクエスト受付とレコメンド生成）_

- [ ] 5.7 追加商品取得APIエンドポイントの実装
  - GET /api/recommendations/nextエンドポイントを実装
  - 無限スクロール対応のための追加商品生成
  - キャッシュとの統合
  - _Requirements: 3.9（無限スクロール的な体験）_

---

- [ ] 6. フロントエンド基盤とUI実装
- [ ] 6.1 ルーティングとページ構造の構築
  - React Routerのセットアップ
  - ホーム画面（RequestInputPage）のルーティング
  - レコメンド画面（RecommendationPage）のルーティング
  - 興味ありリスト画面のルーティング
  - _Requirements: 全画面遷移の基盤_

- [ ] 6.2 グローバルステート管理の実装
  - Context APIまたはZustandでグローバルステートを管理
  - ユーザーID、リクエスト履歴、興味ありリストの状態管理
  - _Requirements: アプリケーション全体の状態管理_

- [ ] 6.3 APIクライアントの実装
  - バックエンドAPIとの通信を行うHTTPクライアントを実装
  - エラーハンドリングとリトライロジック
  - レスポンスの型定義
  - _Requirements: フロントエンドとバックエンド間の通信_

- [ ] 6.4 共通UIコンポーネントの実装
  - ボタンコンポーネント（ミニマルデザイン、タップ領域44x44px以上）
  - ローディングインジケーター
  - エラーメッセージ表示コンポーネント
  - モーダルベースコンポーネント
  - _Requirements: 6.6（大きく押しやすいボタン）、6.1〜6.9（ミニマルデザイン）_

- [ ] 6.5 デザインシステムとスタイリングの構築
  - カラーパレットの定義（白、黒、グレー、アクセントカラー）
  - タイポグラフィの設定（Inter、Noto Sans JP等のモダンフォント）
  - 余白とレイアウトのガイドライン
  - CSS-in-JS or Tailwind CSSの設定
  - _Requirements: 6.4, 6.5（モダンフォント、洗練された配色）_

---

- [ ] 7. 商品リクエスト画面の実装
- [ ] 7.1 リクエスト入力画面のUI実装
  - 検索バーを中央に大きく配置
  - プレースホルダーテキストの設定（「何をお探しですか？」）
  - Enterキーでリクエスト送信
  - ローディング状態の表示（3秒以内にインジケーターを表示）
  - _Requirements: 1.1, 1.6（リクエスト入力画面とローディング表示）_

- [ ] 7.2 リクエスト送信機能の実装
  - 入力バリデーション（空文字列チェック）
  - APIクライアントを使用してPOST /api/recommendationsを呼び出し
  - レスポンスを受け取り、推薦商品画面に遷移
  - エラーハンドリング（400、500エラーの表示）
  - _Requirements: 1.2（リクエストを受け付け、AIレコメンデーション処理を開始）_

---

- [ ] 8. Tinder型スワイプUIの実装
- [ ] 8.1 スワイプカードコンポーネントの基本実装
  - 商品情報を表示するカードUIを実装（商品画像、名前、価格、おすすめ理由）
  - React SpringとReact Use Gestureのセットアップ
  - 基本的なドラッグ操作の検出
  - _Requirements: 3.1, 3.2（商品を大きく表示、商品情報の明確な表示）_

- [ ] 8.2 スワイプアニメーションの実装
  - 右スワイプ時のアニメーション（カードが右に移動し消える）
  - 左スワイプ時のアニメーション（カードが左に移動し消える）
  - スワイプ途中での引き戻し処理
  - 60fps以上のスムーズなアニメーションを実現
  - _Requirements: 3.7（60fps以上のスムーズなアニメーション）_

- [ ] 8.3 スワイプ判定とアクションの実装
  - 右スワイプで「興味あり」としてマーク
  - 左スワイプで「興味なし」としてマーク
  - 「興味あり」「興味なし」ボタンのタップ対応
  - 次の商品カードを表示
  - _Requirements: 3.3, 3.4, 3.5, 3.6（スワイプ判定とボタン対応）_

- [ ] 8.4 スワイプ履歴の保存機能の実装
  - スワイプ時にPOST /api/swipesを呼び出し
  - オプティミスティックUI（ローカルステートを即座に更新）
  - 非同期でバックエンドに保存
  - _Requirements: 7.2（スワイプ方向と商品情報をユーザープロファイルに記録）_

- [ ] 8.5 全商品スワイプ完了時の処理
  - 全商品をスワイプし終えたら「興味あり」リストを表示
  - 興味ありリストが空の場合のフォールバック処理
  - _Requirements: 3.8（全商品スワイプ後の興味ありリスト表示）_

- [ ] 8.6 無限スクロール機能の実装
  - 残り商品が1件以下になったら追加商品を自動取得
  - GET /api/recommendations/nextを呼び出し
  - 新しい商品カードをスタックに追加
  - _Requirements: 3.9（無限スクロール的な体験）_

---

- [ ] 9. 商品詳細モーダルの実装
- [ ] 9.1 商品詳細モーダルのUI実装
  - モーダルを下からスライドインで表示
  - 商品画像、名前、価格、説明、スペック、レビュー評価、レビュー数、販売元を表示
  - 「興味あり」「興味なし」ボタンを配置
  - 「閉じる」ボタンと背景タップで閉じる機能
  - _Requirements: 4.1, 4.2, 4.3, 4.5（商品詳細の表示とボタン配置）_

- [ ] 9.2 商品詳細表示のトリガー実装
  - 商品カードのタップまたは上スワイプでモーダルを開く
  - モーダル内でのスワイプ判断後、元の画面に戻る
  - _Requirements: 4.2, 4.4（詳細情報パネルの表示とクローズ）_

---

- [ ] 10. ユーザープロファイルとパーソナライゼーションの実装
- [ ] 10.1 ユーザー登録と管理の実装
  - 初回アクセス時に匿名ユーザーIDを生成（UUIDv4）
  - ローカルストレージまたはCookieにユーザーIDを保存
  - バックエンドでusersテーブルに新規ユーザーを登録
  - _Requirements: 7.1（初回アクセス時のユーザー登録）_

- [ ] 10.2 スワイプ履歴記録APIの実装
  - POST /api/swipesエンドポイントを実装
  - スワイプ方向（left/right）と商品情報をswipe_historyテーブルに保存
  - ユーザープロファイルとの関連付け
  - _Requirements: 7.2（スワイプ履歴の記録）_

- [ ] 10.3 購買遷移記録APIの実装
  - POST /api/affiliate-linkエンドポイントで購買遷移ログを保存
  - purchase_historyテーブルに商品情報とアフィリエイトURLを記録
  - _Requirements: 7.3（購買遷移履歴の記録）_

- [ ] 10.4 ユーザープロファイル取得APIの実装
  - GET /api/users/:userIdエンドポイントを実装
  - スワイプ履歴、購買履歴、嗜好情報を返却
  - _Requirements: 7.1〜7.3（ユーザープロファイルの取得）_

- [ ] 10.5 嗜好分析ロジックの実装
  - スワイプ履歴が10件以上蓄積された時点で嗜好パターンを分析
  - 好きなカテゴリ、価格帯、ブランドを抽出
  - user_preferencesテーブル（JSONB型）に保存
  - _Requirements: 7.4（嗜好パターンの分析）_

- [ ] 10.6 パーソナライゼーションの適用
  - レコメンド時に嗜好情報を考慮
  - 好きなブランドや価格帯に合致する商品の優先度を上げる
  - _Requirements: 7.5, 7.6（嗜好に基づくレコメンドの優先順位調整）_

- [ ] 10.7 ユーザープロファイル画面の実装
  - ユーザーの嗜好傾向（カテゴリ、平均予算、好きなブランド）を可視化
  - シンプルなグラフまたはリスト形式で表示
  - _Requirements: 7.7（嗜好傾向の可視化）_

---

- [ ] 11. アフィリエイトリンク生成と購入遷移の実装
- [ ] 11.1 購入元選択UIの実装
  - 「購入する」ボタンタップ時に購入元選択画面を表示
  - Amazon、楽天、Yahoo!ショッピングの選択肢を提示
  - 各サイトの価格を比較表示
  - _Requirements: 5.2, 5.3（購入元選択と価格比較表示）_

- [ ] 11.2 アフィリエイトリンク生成機能の実装
  - Amazon、楽天、Yahoo!ショッピングのアフィリエイトリンク生成ロジックを実装
  - アフィリエイトIDを適切に付与
  - リンク生成ルールをテスト
  - _Requirements: 5.4, 5.5（アフィリエイトリンクの生成とAPI利用規約遵守）_

- [ ] 11.3 購入遷移APIエンドポイントの実装
  - POST /api/affiliate-linkエンドポイントを実装
  - アフィリエイトリンクを生成し返却
  - 購買遷移ログをpurchase_historyテーブルに保存
  - _Requirements: 5.4, 5.7（アフィリエイトリンク生成と購買遷移ログ保存）_

- [ ] 11.4 外部サイトへの遷移処理の実装
  - 新しいタブでアフィリエイトサイトを開く機能を実装
  - ステマ規制対応（アフィリエイトであることを明示）
  - _Requirements: 5.4, 5.6（外部サイトへの遷移とステマ規制対応）_

---

- [ ] 12. レスポンシブデザインの実装
- [ ] 12.1 モバイルファーストレイアウトの実装
  - スマートフォン向けのレイアウトを優先的に実装
  - タッチ操作に最適化したUI（タップ領域44x44px以上）
  - _Requirements: 8.1（モバイルファーストレイアウト）_

- [ ] 12.2 タブレット・PCレイアウトの実装
  - タブレット向けのレイアウト調整
  - PC（デスクトップ）向けの大画面レイアウト
  - メディアクエリの設定
  - _Requirements: 8.2, 8.3（タブレット、PC向けレイアウト）_

- [ ] 12.3 デバイス対応の実装
  - タッチ操作、マウス操作、キーボード操作の全てに対応
  - 画面回転時のレイアウト調整
  - _Requirements: 8.4, 8.5（全操作方法への対応、画面回転対応）_

---

- [ ] 13. 非機能要件の実装
- [ ] 13.1 パフォーマンス最適化
  - レコメンド生成時間を10秒以内に最適化（並列API呼び出し、キャッシング）
  - スワイプアニメーションを60fps以上に最適化
  - 初回ロード時間を3秒以内に最適化（コード分割、遅延ロード）
  - _Requirements: Non-Functional Requirements - Performance_

- [ ] 13.2 セキュリティ対策の実装
  - 全通信をHTTPS化（TLS 1.2以上）
  - 個人情報の最小化（氏名、住所、電話番号等を収集しない）
  - APIキーの安全な管理（環境変数、秘密管理サービス）
  - _Requirements: Non-Functional Requirements - Security_

- [ ] 13.3 ユーザビリティの最適化
  - タップ/クリック可能な領域を最小44x44pxに設定
  - フォントサイズを最小16px（モバイル）に設定
  - 全アクションに視覚的フィードバックを追加
  - _Requirements: Non-Functional Requirements - Usability_

- [ ] 13.4 アクセシビリティ対応
  - 全画像にalt属性を設定
  - 色のコントラスト比をWCAG AA基準（4.5:1以上）に準拠
  - キーボードのみで全機能にアクセス可能にする
  - _Requirements: Non-Functional Requirements - Accessibility_

- [ ] 13.5 コンプライアンス対応
  - ステマ規制対応（アフィリエイトであることを明示）
  - 公式アフィリエイトプログラムの素材のみを使用
  - プライバシーポリシーに基づくユーザー同意の取得
  - _Requirements: Non-Functional Requirements - Compliance_

---

- [ ] 14. テストの実装
- [ ] 14.1 フロントエンドユニットテストの実装
  - SwipeCardComponentのスワイプジェスチャーテスト
  - RequestInputPageの入力バリデーションテスト
  - ProductDetailModalのモーダル開閉テスト
  - _Requirements: Testing Strategy - Unit Tests (Frontend)_

- [ ] 14.2 バックエンドユニットテストの実装
  - AIRecommendationEngine.scoreProduct()のテスト
  - AffiliateLinkService.generateAffiliateLink()のテスト
  - UserProfileService.analyzePreferences()のテスト
  - _Requirements: Testing Strategy - Unit Tests (Backend)_

- [ ] 14.3 API統合テストの実装
  - POST /api/recommendationsの統合テスト
  - POST /api/swipesの統合テスト
  - POST /api/affiliate-linkの統合テスト
  - _Requirements: Testing Strategy - Integration Tests (API)_

- [ ] 14.4 外部API統合テストの実装
  - Amazon PA-APIとの統合テスト
  - 楽天市場APIとの統合テスト
  - Claude APIとの統合テスト
  - _Requirements: Testing Strategy - Integration Tests (External API)_

- [ ] 14.5 E2Eテストの実装
  - リクエスト入力 → 推薦商品閲覧 → スワイプ → 購入遷移の一連のフローテスト
  - 詳細モーダルを開く → 商品詳細閲覧 → スワイプ判断のフローテスト
  - 興味ありリスト → 購入元選択 → アフィリエイトサイト遷移のフローテスト
  - _Requirements: Testing Strategy - E2E Tests_

- [ ] 14.6 パフォーマンステストの実装
  - 同時100ユーザーがリクエストを送信した場合のレスポンスタイムテスト
  - 1秒間に10リクエストが送信された場合のスループットテスト
  - データベースのクエリパフォーマンステスト
  - _Requirements: Testing Strategy - Performance Tests_

---

- [ ] 15. 統合とE2Eフローの完成
- [ ] 15.1 全コンポーネントの統合
  - フロントエンドとバックエンドの全機能を統合
  - APIエンドポイントとフロントエンドのページを接続
  - エラーハンドリングの一貫性を確認
  - _Requirements: 全要件の統合_

- [ ] 15.2 E2Eユーザーフローの検証
  - ユーザーがリクエストを入力してから購入遷移までの完全なフローをテスト
  - 各ステップでの動作を確認
  - エッジケース（APIエラー、タイムアウト等）の動作を確認
  - _Requirements: 全要件の動作確認_

- [ ] 15.3 デザインとUXの最終調整
  - ミニマルデザインの一貫性を確認
  - 余白、フォント、色の最終調整
  - 高齢者でも使いやすいUIかを検証
  - _Requirements: 6.1〜6.9（ミニマルデザインのUI/UX）_

- [ ] 15.4 パフォーマンスとセキュリティの最終確認
  - 全ての非機能要件を満たしているか確認
  - レスポンスタイム、アニメーションfps、ロード時間を計測
  - セキュリティ脆弱性スキャンを実施
  - _Requirements: Non-Functional Requirements（全項目）_

---

## 実装の進め方

1. **順次実装**: タスクは上から順に実装してください。各タスクは前のタスクの成果物を活用します。
2. **テスト駆動**: 各タスク完了後、対応するテストを実装し、動作を確認してください。
3. **コミット**: 大きなタスク（メジャータスク）が完了したらGitにコミットしてください。
4. **レビュー**: 定期的にコードレビューを行い、品質を維持してください。

---

## 要件カバレッジ確認

以下の要件が全てタスクでカバーされていることを確認してください：

- ✅ Requirement 1: 商品リクエスト機能（タスク7で実装）
- ✅ Requirement 2: AIレコメンデーションエンジン（タスク5で実装）
- ✅ Requirement 3: Tinder型スワイプUI（タスク8で実装）
- ✅ Requirement 4: 商品詳細表示（タスク9で実装）
- ✅ Requirement 5: アフィリエイト統合と購入遷移（タスク11で実装）
- ✅ Requirement 6: ミニマルデザインのUI/UX（タスク6、13で実装）
- ✅ Requirement 7: ユーザープロファイルと基本的なパーソナライゼーション（タスク10で実装）
- ✅ Requirement 8: レスポンシブデザイン（タスク12で実装）
- ✅ Non-Functional Requirements（タスク13で実装）
- ✅ Testing Strategy（タスク14で実装）

全ての要件がタスクでカバーされています。実装を開始してください！
